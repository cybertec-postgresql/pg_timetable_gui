object dmPgEngine: TdmPgEngine
  OldCreateOrder = False
  Height = 524
  HorizontalOffset = 2019
  VerticalOffset = 712
  Width = 668
  PPI = 144
  object dsChains: TDataSource
    DataSet = qryChains
    Left = 108
    Top = 48
  end
  object PQConn: TPQConnection
    Connected = False
    LoginPrompt = True
    OnLogin = PQConnLogin
    DatabaseName = 'timetable'
    KeepConnection = False
    Password = 'somestrong'
    Transaction = transChains
    UserName = 'scheduler'
    OnLog = PQConnLog
    LogEvents = [detParamValue, detActualSQL]
    Left = 105
    Top = 312
  end
  object qryChains: TSQLQuery
    PacketRecords = -1
    IndexName = 'DEFAULT_ORDER'
    MaxIndexesCount = 20
    FieldDefs = <>
    AfterClose = qryChainsAfterClose
    AfterDelete = qryChainsAfterDelete
    AfterInsert = qryChainsAfterInsert
    AfterPost = qryAfterPost
    BeforeDelete = qryChainsBeforeDelete
    Database = PQConn
    Transaction = transChains
    SQL.Strings = (
      'SELECT'
      '  chain_id,'
      '  task_id,'
      '  chain_name,'
      '  COALESCE(run_at, ''* * * * *'') as run_at,'
      '  max_instances,'
      '  live,'
      '  self_destruct,'
      '  exclusive_execution,'
      '  client_name,'
      '  timeout,'
      '  max_instances'
      'FROM timetable.chain'
      'ORDER BY chain_id'
    )
    InsertSQL.Strings = (
      'INSERT INTO timetable.chain ('
      #9'"task_id",'
      #9'"chain_name",'
      #9'"run_at",'
      #9'"max_instances",'
      #9'"live",'
      #9'"self_destruct",'
      #9'"exclusive_execution",'
      #9'"client_name",'
      '  "timeout"'
      ') VALUES ('
      #9'timetable.add_task(''SQL'', ''SELECT 1'', NULL),'
      #9':"chain_name",'
      #9':"run_at",'
      #9':"max_instances",'
      #9':"live",'
      #9':"self_destruct",'
      #9':"exclusive_execution",'
      #9':"client_name",'
      '  :"timeout"'
      ')'
    )
    UpdateSQL.Strings = (
      'UPDATE timetable.chain'
      'SET'
      #9'"task_id"=:"task_id",'
      #9'"chain_name"=:"chain_name",'
      #9'"run_at"=:"run_at",'
      #9'"max_instances"=:"max_instances",'
      #9'"live"=:"live",'
      #9'"self_destruct"=:"self_destruct",'
      #9'"exclusive_execution"=:"exclusive_execution",'
      #9'"client_name"=:"client_name",'
      '  "timeout"=:"timeout"'
      'WHERE'
      #9'"chain_id"= :"OLD_chain_id"'
    )
    DeleteSQL.Strings = (
      'DELETE FROM timetable.chain'
      'WHERE chain_id = :"old_chain_id"'
    )
    Options = [sqoKeepOpenOnCommit, sqoAutoCommit]
    Params = <>
    ParamCheck = False
    ParseSQL = False
    UsePrimaryKeyAsKey = False
    Left = 105
    Top = 177
  end
  object transChains: TSQLTransaction
    Active = False
    Database = PQConn
    Options = [stoUseImplicit]
    Left = 192
    Top = 312
  end
  object qryTasks: TSQLQuery
    PacketRecords = -1
    IndexName = 'DEFAULT_ORDER'
    MaxIndexesCount = 4
    FieldDefs = <>
    AfterInsert = qryTasksAfterInsert
    AfterOpen = qryTasksAfterOpen
    AfterPost = qryAfterPost
    AfterRefresh = qryTasksAfterOpen
    BeforePost = qryTasksBeforePost
    Database = PQConn
    Transaction = transChains
    SQL.Strings = (
      'WITH RECURSIVE x ('
      '    parent_id,'
      '    task_id,'
      '    command,'
      '    kind,'
      '    run_as,'
      '    ignore_error,'
      '    autonomous,'
      '    connect_string'
      ') AS ('
      '    SELECT'
      '        NULL::bigint,'
      '        tc.task_id,'
      '        tc.command,'
      '        tc.kind,'
      '        tc.run_as,'
      '        tc.ignore_error,'
      '        tc.autonomous,'
      '        tc.database_connection'
      '    FROM'
      '        timetable.task tc'
      '    WHERE'
      '        tc.parent_id IS NULL'
      '        AND tc.task_id = :"task_id"'
      '    UNION ALL'
      '    SELECT'
      '        tc.parent_id,'
      '        tc.task_id,'
      '        tc.command,'
      '        tc.kind,'
      '        tc.run_as,'
      '        tc.ignore_error,'
      '        tc.autonomous,'
      '        tc.database_connection'
      '    FROM'
      '        timetable.task tc'
      '        JOIN x ON (x.task_id = tc.parent_id))'
      'SELECT'
      '    *'
      'FROM'
      '    x'
    )
    InsertSQL.Strings = (
      'INSERT INTO timetable.task('
      '    parent_id,'
      '    command,'
      '    kind,'
      '    run_as,'
      '    ignore_error,'
      '    autonomous,'
      '    database_connection'
      ') VALUES ('
      '    :"parent_id",'
      '    :"command",'
      '    :"kind",'
      '    :"run_as",'
      '    :"ignore_error",'
      '    :"autonomous",'
      '    :"connect_string"'
      ')'
    )
    Options = [sqoKeepOpenOnCommit, sqoAutoApplyUpdates, sqoAutoCommit, sqoRefreshUsingSelect]
    Params = <    
      item
        DataType = ftLargeint
        Name = 'task_id'
        ParamType = ptInput
        Size = 8
      end>
    ParseSQL = False
    UpdateMode = upWhereAll
    DataSource = dsChains
    Left = 192
    Top = 177
  end
  object dsTasks: TDataSource
    DataSet = qryTasks
    Left = 192
    Top = 48
  end
end
